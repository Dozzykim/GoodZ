<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springproject.goodz.pay.mapper.PayMapper">

	<!-- 구매 등록 -->
  <insert id="insertPurchase" parameterType="Purchase">
	<selectKey keyProperty="purchaseNo" resultType="int" order="AFTER">
		SELECT LAST_INSERT_ID()
	</selectKey>
    INSERT INTO Purchase (user_id, p_no, purchase_price, payment_method, purchase_state, option_id)
    VALUES (#{userId}, #{pNo}, #{purchasePrice}, #{paymentMethod}, #{purchaseState}, #{optionId})
  </insert>

	<!-- 구매 업데이트 -->
	<update id="updatePurchase" parameterType="Purchase">
		UPDATE Purchase
		SET purchase_state = #{purchaseState},
			order_id = #{orderId},
			address = #{address},
			updated_at = CURRENT_TIMESTAMP
		WHERE purchase_no = #{purchaseNo}
	</update>

	<!-- 판매 등록 -->
	<insert id="insertSale" parameterType="Sales">
		INSERT INTO Sales (user_id, p_no, size, sale_tracking_no, address, sale_price, sale_state, sale_date)
		VALUES (#{userId}, #{pNo}, #{size}, #{saleTrackingNo}, #{address}, #{salePrice}, #{saleState}, NOW())
	</insert>

	<select id="selectPurchase" resultType="Purchase">
		SELECT *
		FROM Purchase
		WHERE purchase_no = #{purchaseNo}
	</select>


	<select id="findPurchasesByUserId">
		SELECT 
			purchase_no AS purchaseNo,
			user_id AS userId,
			p_no AS pNo,
			option_id AS optionId,
			order_id AS orderId,
			purchase_price AS purchasePrice,
			payment_method AS paymentMethod,
			purchase_state AS purchaseState,
			ordered_at AS orderedAt,
			updated_at AS updatedAt
		FROM 
			Purchase
		WHERE 
			user_id = #{userId}
	</select>	


	<select id="findSalesByUserId">
		SELECT *
		  FROM sales
		 WHERE user_id = #{userId}
	</select>
</mapper>