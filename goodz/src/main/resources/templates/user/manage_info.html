<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/mypage_layout}"
>
<head>
    <style>
        .shopping-info {
            margin-top: 50px; 
        }
        .content {
            padding: 15px;
            margin-top: 20px; 
        }
        .card-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 15px; /* 여백 추가 */
        }
        
        .profile-details {
            display: flex;
            align-items: center;
        }
        .profile_img {
            width: 55px;
            height: 55px;
            border-radius: 50%; /* 둥근 모서리 */
            overflow: hidden; /* 이미지가 컨테이너를 벗어나지 않도록 설정 */
            margin-right: 15px;
        }

        .profile_img img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 이미지 비율을 유지하면서 컨테이너에 맞춤 */
        }
        .profile-info {
            display: flex;
            flex-direction: column;
            margin-top: 5px; /* 텍스트 부분 전체를 아래로 이동 */
        }

        .profile-info .user-id {
            font-size: 1.1rem; 
            font-weight: bold; 
            margin: 0;
        }
        .profile-info .nickname {
            font-size: 0.875rem; 
            margin: 0;
        }
        .profile-buttons {
            display: flex;
            gap: 5px;
        }
        .card {
            max-width: 640px;
            margin-bottom: 40px;
        }
        .wishlist img {
            width: 100%;
        }
        .wishlist .col-md-3 {
            padding: 0 5px;
        }
        .purchase-summary .col {
            margin-top: 10px; /* 구매 내역과 전체 사이의 간격 추가 */
        }
    </style>

    <title>마이 페이지-내 정보 관리</title>
</head>
<body layout:fragment="content">
    <div class="container">
        <div class="UserMainContainer">
            
            <div class="row mx-auto">
                <div class="col-md-9 content">
                    <div class="card">
                        <div class="card-body">
                            <div class="card-title-section">
                                <div class="profile-details">
                                    <div class="profile_img">
                                        <img th:src="${user != null and user.profilePictureUrl != null ? user.profilePictureUrl : '/img/user/basic_social.png'}" alt="프로필이미지" class="rounded-circle">
                                    </div>
                                    <div class="profile-info">
                                        <p class="nickname" id="nickname" th:text="${user != null ? user.nickname : 'Error'}"></p>
                                        <p class="user-id" id="userId" name="userId" th:text="${user != null ? user.userId : 'Error'}"></p>
                                    </div>
                                </div>
                                <div class="profile-buttons">
                                    <button class="btn btn-sm btn-outline-secondary">스타일</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <form class="row g-3 needs-validation" method="POST" action="/upload" enctype="multipart/form-data" novalidate id="profile-form">

                        <div class="form-group">
                            <label for="formFile" class="form-label">프로필 사진 수정*</label>
                            <div class="input-group" style="max-width: 640px;">
                                <input type="file" class="form-control rounded-1" name="file" id="file" placeholder="첨부파일을 등록해주세요.">
                            </div>
                        </div>
                        
                        <div class="position-relative" style="max-width: 655px;">
                            <label for="nickName" class="form-label">닉네임*</label>
                            <input type="text" class="form-control" id="nickName" th:value="${user.nickname}" required style="width: 100%;">
                        </div>
                    
                        <div class="form-group">
                            <label for="password">비밀번호*</label>
                            <div class="input-group">
                                <input type="password" class="form-control me-2 rounded-1" id="password" placeholder="********" style="max-width: 640px;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="password_check">비밀번호 확인*</label>
                            <div class="input-group">
                                <input type="password" class="form-control me-2 rounded-1" id="passwordCheck" placeholder="********" style="max-width: 640px;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="phone_number">핸드폰 번호 수정*</label>
                            <div class="input-group">
                                <input type="text" class="form-control me-2 rounded-1" id="phoneNumber" 
                                    style="max-width: 640px;" placeholder="'-'을 제외하고 입력해주세요.">
                            </div>
                        </div>

                        <div class="col-12 d-flex justify-content-end"  style="max-width: 640px;">
                            <button class="btn btn-dark" type="button" onclick="check()">저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function checkNickname(callback) {
            var userId = $('#userId').text();
            var nickname = $('#nickName').val();
            var csrfToken = $('input[name=_csrf]').val(); // CSRF 토큰 값 가져오기

            if(nickname === '') {
                alert('닉네임을 입력해주세요.');
                return false;
            }
            var data = {
                userId: userId,
                nickname: nickname
            };

            $.ajax({
                url: '/user/check',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken); // CSRF 토큰 설정
                },
                success: function(response) {
                    callback(true);
                },
                error: function(xhr, status, error) {
                    if(xhr.status === 409) {
                        alert('이미 사용 중인 닉네임입니다.');
                    } else {
                        alert('오류가 발생했습니다. 다시 시도해 주세요.');
                    }
                    callback(false);
                }
            });
        }

        function checkPassword(callback) {
            var password = $('#password').val();
            var userId = $('#userId').text(); // UserId 텍스트로 가져오기
            var csrfToken = $('input[name=_csrf]').val(); // CSRF 토큰 값 가져오기

            $.ajax({
                url: '/user/checkPassword',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ userId: userId, password: password }),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken); // CSRF 토큰 설정
                },
                success: function(response) {
                    callback(true);
                },
                error: function(xhr, status, error) {
                    alert('비밀번호가 일치하지 않습니다.');
                    callback(false);
                }
            });
        }
        
        function formatPhoneNumber(phone) {
            // 숫자만 추출
            var cleaned = ('' + phone).replace(/\D/g, '');
            var match = cleaned.match(/^(\d{3})(\d{4})(\d{4})$/);
            if (match) {
                return match[1] + '-' + match[2] + '-' + match[3];
            }
            return null;
        }

        function check() {
            var firstPw = $('#password').val();
            var secondPw = $('#passwordCheck').val();
            var phone = $('#phoneNumber').val();
            var formattedPhone = formatPhoneNumber(phone);
            console.log(formattedPhone);
            console.log(formattedPhone);
            console.log(formattedPhone);
            console.log(formattedPhone);
            console.log(formattedPhone);

            if(formattedPhone !== null && !formattedPhone) {
                alert('올바른 휴대폰 번호를 입력해주세요.');
                return;
            }

            if (firstPw !== secondPw) {
                alert('비밀번호와 비밀번호 확인이 일치하지 않습니다.');
                return;
            }

            checkNickname(function(isNicknameValid) {
                if (!isNicknameValid) {
                    return;
                }
                checkPassword(function(isPasswordValid) {
                    if (!isPasswordValid) {
                        return;
                    }
                    // 모든 조건이 충족되면 사용자 정보를 저장
                    var userData = new FormData(); // FormData 객체 생성
                    userData.append('userId', $('#userId').text()); // 추가
                    userData.append('nickname', $('#nickName').val());
                    if (formattedPhone) {
                        userData.append('phoneNumber', formattedPhone); // phoneNumber 추가
                    }
                    
                    var fileInput = $('#file')[0];
                    if (fileInput.files.length > 0) {
                        userData.append('file', fileInput.files[0]); // 파일 추가
                    }

                    var csrfToken = $('input[name="_csrf"]').val(); // CSRF 토큰 값 가져오기

                    $.ajax({
                        url: '/user/update',
                        type: 'POST',
                        data: userData,
                        processData: false,
                        contentType: false,
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
                        },
                        success: function(response) {
                            alert('회원 정보 수정이 완료되었습니다.');
                            window.location.href = '/user/login';
                        },
                        error: function(xhr, status, error) {
                            alert('회원 정보 수정에 실패했습니다. 다시 시도해 주세요.');
                        }
                    });
                });
            });
        }

        document.getElementById('profile-form').addEventListener('submit', function(event) {
            event.preventDefault(); // 기본 폼 제출을 막음
            check(); // 검증 및 AJAX 요청 수행
        });
    </script>
</body>
</html>
